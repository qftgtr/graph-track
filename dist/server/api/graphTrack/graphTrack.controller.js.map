{"version":3,"sources":["api/graphTrack/graphTrack.controller.js"],"names":[],"mappings":"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","file":"api/graphTrack/graphTrack.controller.js","sourcesContent":["/**\n * Using Rails-like standard naming convention for endpoints.\n * POST    /api/launch             ->  launch\n * POST    /api/transition         ->  transition\n * POST    /api/exit               ->  exit\n */\n\n'use strict';\n\nimport _ from 'lodash';\nimport GraphTrack from './graphTrack.model';\nvar {GT_States, GT_Edges} = GraphTrack;\n\nfunction respondWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function(entity) {\n    if (entity) {\n      res.status(statusCode).json(entity);\n    }\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\n\nexport function launch(req, res) {\n  const data = req.query;\n  if (!data.appVersion)\n    return res.status(404).json({ok: 0, msg: 'app version required'}).end();\n\n  const version = parseAppVersion(data.appVersion),\n        state = data.state || 'emptystate',\n        path = data.launchFrom || 'default';\n  \n  Promise.all([\n    incState(version, 'launch'),\n    incState(version, state),\n    incEdge(version, 'launch', state, path),\n  ]).then(respondWithResult(res), handleError(res));\n}\n\nexport function transition(req, res) {\n  const data = req.query;\n  if (!data.appVersion)\n    return res.status(404).json({ok: 0, msg: 'app version required'}).end();\n\n  const version = parseAppVersion(data.appVersion),\n        stateFrom = data.stateFrom || 'emptystate',\n        stateTo = data.stateTo || 'emptystate',\n        path = data.path || 'default';\n  \n  Promise.all([\n    incState(version, stateTo, res),\n    incEdge(version, stateFrom, stateTo, path, res),\n  ]).then(respondWithResult(res), handleError(res));\n}\n  \nexport function exit(req, res) {\n  const data = req.query;\n  if (!data.appVersion)\n    return res.status(404).json({ok: 0, msg: 'app version required'}).end();\n\n  const version = parseAppVersion(data.appVersion),\n        state = data.state || 'emptystate';\n  \n  Promise.all([\n    incState(version, 'exit'),\n    incEdge(version, state, 'exit', 'default'),\n  ]).then(respondWithResult(res), handleError(res));\n}\n\n\nfunction incState(version, state) {\n  const id = [version, state].join('_');\n  \n  return GT_States.update({_id: id}, {$inc: {count: 1}}).exec()\n    .then(function(result) {\n      if (result.nModified)\n        return result;\n    \n      return GT_States.create({\n        _id: id,\n        version: version,\n        state: state,\n        count: 1,\n      });\n    });\n}\n\nfunction incEdge(version, stateFrom, stateTo, path) {\n  const id = [version, stateFrom, stateTo, path].join('_');\n  \n  return GT_Edges.update({_id: id}, {$inc: {count: 1}}).exec()\n    .then(function(result) {\n      if (result.nModified)\n        return result;\n\n      return GT_Edges.create({\n        _id: id,\n        stateFrom: stateFrom,\n        stateTo: stateTo,\n        path: path,\n        version: version,\n        count: 1,\n      });\n    });\n}\n\nfunction parseAppVersion(v) {\n  const version = v.split('.'),\n    major = parseInt(version[0],10) || '0',\n    minor = parseInt(version[1],10) || '0',\n    fix = parseInt(version[2],10) || '0';\n  return [major, minor, fix].join('.');\n}"],"sourceRoot":"/source/"}