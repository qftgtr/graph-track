{"version":3,"sources":["api/graphTrack/graphTrack.controller.js"],"names":[],"mappings":"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","file":"api/graphTrack/graphTrack.controller.js","sourcesContent":["/**\n * Using Rails-like standard naming convention for endpoints.\n * POST    /api/launch             ->  launch\n * POST    /api/go                 ->  go\n * POST    /api/exit               ->  exit\n */\n\n'use strict';\n\nimport _ from 'lodash';\nimport GraphTrack from './graphTrack.model';\nconst {GT_States, GT_Edges, GT_Sessions} = GraphTrack;\n\nfunction respondWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function(entity) {\n    if (entity) {\n      res.status(statusCode).json(entity);\n    }\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\nexport function launch(req, res) {\n  console.log(req.query);\n  const {appVersion, launchFrom} = req.query;\n  \n  if (!appVersion)\n    return res.status(404).json({ok: 0, msg: 'app version required'}).end();\n  \n  const version = parseAppVersion(appVersion);\n  \n  endTrack()\n    .then(() => {\n      return GT_Sessions.create({\n        version,\n        state: '',\n      });\n    })\n    .then(result => {\n      if (launchFrom) {\n        return Promise.all([\n          incState(version, 'launch'),\n          launchState(version, launchFrom, 'launch'),\n          setCurrentState(result._id, launchFrom),\n        ]);\n      } else {\n        return incState(version, 'launch');\n      }\n    })\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\nexport function go(req, res) {\n  console.log(req.query);\n  const {state, path} = req.query;\n  \n  if (!state)\n    return res.status(404).json({ok: 0, msg: 'state required'}).end();\n  \n  GT_Sessions.findOne({})\n    .then(result => {\n      if (!result) {\n        return {ok: 0, msg: 'no session'};\n      }\n    \n      if (result.state === state) {\n        return {ok: 0, msg: 'repeated state'};\n      }\n    \n      if (result.state) {\n        return Promise.all([\n          incEdge(result.version, result.state, state),\n          incState(result.version, state),\n          setCurrentState(result._id, state),\n        ]);\n      } else {\n        return Promise.all([\n          launchState(result.version, state),\n          setCurrentState(result._id, state),\n        ]);\n      }\n    })\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n  \nexport function exit(req, res) {\n  endTrack()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\nexport function graph(req, res) {\n  const {appVersion} = req.query;\n  \n  if (!appVersion)\n    return res.status(404).json({ok: 0, msg: 'app version required'}).end();\n  \n  const version = parseAppVersion(appVersion);\n  \n  Promise.all([\n    GT_States.find({version: version}, {\n      _id: false,\n      state: true,\n      count: true,\n      launch: true,\n      exit: true,\n    }).exec(),\n    GT_Edges.find({version: version}, {\n      _id: false,\n      state_from: true,\n      state_to: true,\n      count: true,\n    }).exec(),\n  ]).then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n\nfunction launchState(version, state, type) {\n  const _id = [version, state].join('_');\n  \n  return GT_States.update({_id}, {$inc: {count: 1, launch: 1}}).exec()\n    .then(result => {\n      if (result.nModified)\n        return result;\n    \n      return GT_States.create({\n        _id,\n        version,\n        state,\n        count: 1,\n        launch: 1,\n        exit: 0,\n      });\n    });\n}\n  \nfunction incState(version, state) {\n  const _id = [version, state].join('_');\n  \n  return GT_States.update({_id}, {$inc: {count: 1}}).exec()\n    .then(result => {\n      if (result.nModified)\n        return result;\n    \n      return GT_States.create({\n        _id,\n        version,\n        state,\n        count: 1,\n        launch: 0,\n        exit: 0,\n      });\n    });\n}\n\nfunction incEdge(version, stateFrom, stateTo) {\n  const _id = [version, stateFrom, stateTo].join('_');\n  \n  return GT_Edges.update({_id}, {$inc: {count: 1}}).exec()\n    .then(result => {\n      if (result.nModified)\n        return result;\n\n      return GT_Edges.create({\n        _id,\n        version,\n        state_from: stateFrom,\n        state_to: stateTo,\n        count: 1,\n      });\n    });\n}\n\nfunction endTrack() {\n  return GT_Sessions.findOne({})\n    .then(result => {\n      return result ? Promise.all([\n        exitState(result.version, result.state),\n        incState(result.version, 'exit'),\n        GT_Sessions.remove({_id: result._id}),\n      ]) : null;\n    });\n}\n\nfunction exitState(version, state) {\n  const _id = [version, state].join('_');\n  return GT_States.update({_id}, {$inc: {exit: 1}}).exec();\n}\n\nfunction setCurrentState(_id, state) {\n  return GT_Sessions.update({_id}, { $set: {state} });\n}\n\nfunction parseAppVersion(v) {\n  const version = v.split('.'),\n    major = parseInt(version[0],10) || '0',\n    minor = parseInt(version[1],10) || '0',\n    fix = parseInt(version[2],10) || '0';\n  return [major, minor, fix].join('.');\n}"],"sourceRoot":"/source/"}